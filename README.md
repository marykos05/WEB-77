# Отчет по аудиту безопасности веб-приложения

# Введение
Безопасность веб-приложений критически важна для защиты данных пользователей и предотвращения атак. В данном отчете рассмотрены основные уязвимости, методы их устранения и реализованные механизмы защиты. На основе анализа кодовой базы приложения были выявлены и устранены следующие уязвимости.

---

# 1. Защита от XSS (Cross-Site Scripting)
## Уязвимость:
XSS позволяет злоумышленнику внедрять вредоносные JavaScript-коды через пользовательский ввод, которые выполняются в браузере других пользователей.

## Методы защиты:
1. **Экранирование вывода**:
   ```php
   function safeOutput($data) {
       return htmlspecialchars($data, ENT_QUOTES | ENT_HTML5, 'UTF-8', true);
   }
   ```
   Где:
   - `ENT_QUOTES` — экранирует и двойные, и одинарные кавычки.
   - `ENT_HTML5` — оптимизация для HTML5.
   - `UTF-8` — корректная обработка юникода.
   - `true` — двойное экранирование существующих сущностей.

2. **HTTP-заголовки**:
   ```php
   header("X-XSS-Protection: 1; mode=block");
   header("X-Content-Type-Options: nosniff");
   ```

3. **Валидация ввода**:
   - Регулярные выражения для проверки допустимых символов.
   - Фильтрация специальных символов.

## Вывод:
После внедрения защиты:
- Все пользовательские данные перед выводом проходят экранирование.
- Браузер получает четкие инструкции по обработке контента.
- Даже при попытке ввода скриптов они отображаются как текст, а не выполняются.
- Защита работает на всех страницах приложения, где выводится пользовательский ввод.

---

# 2. Защита от Information Disclosure
## Уязвимость:
Раскрытие внутренней информации (ошибки БД, пути к файлам).

## Методы защиты:
1. **Кастомизированные сообщения об ошибках**:
   ```php
   try {
       $stmt = $db->query("SELECT * FROM non_existent_table");
   } catch (PDOException $e) {
       error_log($e->getMessage());
       die("Произошла ошибка. Попробуйте позже.");
   }
   ```
2. **Отключение отображения ошибок**:
   ```php
   ini_set('display_errors', 0);
   ini_set('log_errors', 1);
   error_reporting(E_ALL);
   ```
3. **Удаление чувствительных заголовков**:
   ```php
   header_remove('X-Powered-By');
   ```

## Вывод:
Код защищает веб-приложение от раскрытия внутренней информации об ошибках. Вместо показа пользователю технических деталей (например, ошибки базы данных), он выводит общее сообщение об ошибке и записывает подробности в лог-файл для разработчиков. Это помогает предотвратить утечку данных, полезных для злоумышленников.

---

# 3. Защита от SQL-инъекций
## Уязвимость:
Возможность выполнения произвольных SQL-запросов через пользовательский ввод.

## Методы защиты:
1. **Использование подготовленных выражений (Prepared Statements)**:
   ```php
   $stmt = $db->prepare("INSERT INTO application (fio, phone, email) VALUES (?, ?, ?)");
   $stmt->execute([$fio, $phone, $email]);
   ```
2. **Отключение эмуляции подготовленных выражений**:
   ```php
   new PDO(..., [PDO::ATTR_EMULATE_PREPARES => false]);
   ```
3. **Фильтрация и валидация ввода**:
   ```php
   $id = (int)$_POST['id']; // Пример приведения к числу
   ```

## Вывод:
После внедрения защиты:
- Все SQL-запросы используют подготовленные выражения, что исключает возможность внедрения кода.
- Эмуляция подготовленных выражений отключена для повышения безопасности.
- Пользовательский ввод фильтруется и валидируется перед использованием в запросах.

---

# 4. Защита от CSRF (Межсайтовая подделка запроса)
## Уязвимость:
Возможность выполнения действий от имени авторизованного пользователя без его ведома.

## Методы защиты:
1. **CSRF-токены**:
   ```php
   if (empty($_SESSION['csrf_token'])) {
       $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
   }
   if (!hash_equals($_SESSION['csrf_token'], $_POST['csrf_token'] ?? '')) {
       die('Неверный CSRF-токен');
   }
   ```
2. **SameSite cookies**:
   ```php
   session_set_cookie_params(['samesite' => 'Lax']);
   ```

## Вывод:
После внедрения защиты:
- Каждая форма требует уникальный токен.
- Токен привязан к сессии пользователя.
- Запросы с других сайтов (без токена) отклоняются.
- Куки не отправляются в межсайтовых запросах.

---

# 5. Защита от Include/Upload уязвимостей
## Уязвимость:
Возможность включения произвольных файлов или загрузки вредоносных файлов.

## Методы защиты:
1. **Валидация загружаемых файлов**:
   ```php
   $allowedTypes = ['image/jpeg', 'image/png'];
   $maxSize = 2 * 1024 * 1024; // 2MB
   if (!in_array($_FILES['file']['type'], $allowedTypes)) {
       die('Недопустимый тип файла');
   }
   ```
2. **Генерация уникальных имен файлов**:
   ```php
   $newName = bin2hex(random_bytes(16)) . '.' . $extension;
   ```
3. **Хранение файлов вне корневой директории**:
   ```php
   $uploadPath = '/var/www/private/uploads/' . $newName;
   ```

## Вывод:
Код защищает от уязвимостей, связанных с загрузкой файлов. Он проверяет тип и размер загружаемого файла, разрешая только изображения JPEG и PNG размером до 2МБ. Затем файл сохраняется под уникальным именем в защищенной директории, недоступной напрямую через веб-интерфейс.

---

# Заключение
В результате проведенного аудита и доработок веб-приложение защищено от основных уязвимостей, таких как XSS, SQL-инъекции, CSRF, раскрытие информации и несанкционированная загрузка файлов. Реализованные механизмы обеспечивают безопасность данных пользователей и устойчивость приложения к атакам.
